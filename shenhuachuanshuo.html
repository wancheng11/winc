<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Á•ûËØù‰º†ËØ¥</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            overflow: hidden;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        #game-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .ui-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .status-bar {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            z-index: 100;
            pointer-events: auto;
        }

        .hp-bar, .mp-bar {
            width: 200px;
            height: 20px;
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            overflow: hidden;
        }

        .hp-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff4444, #ff6666);
            width: 100%;
            transition: width 0.3s ease;
        }

        .mp-fill {
            height: 100%;
            background: linear-gradient(90deg, #4444ff, #6666ff);
            width: 100%;
            transition: width 0.3s ease;
        }

        .skill-bar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 100;
            pointer-events: auto;
        }

        .skill-btn {
            width: 60px;
            height: 60px;
            border-radius: 30px;
            background: rgba(0,0,0,0.5);
            border: 2px solid #fff;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .skill-btn:active {
            transform: scale(0.9);
        }

        .virtual-joystick {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 120px;
            height: 120px;
            background: rgba(255,255,255,0.1);
            border-radius: 60px;
            pointer-events: auto;
        }

        .joystick-handle {
            position: absolute;
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.3);
            border-radius: 25px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #fff;
            z-index: 1000;
        }

        .loading-bar {
            width: 200px;
            height: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
            margin-top: 20px;
            overflow: hidden;
        }

        .loading-progress {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #ff4444, #ff6666);
            transition: width 0.3s ease;
        }

        /* Ê∑ªÂä†ËøîÂõûÊåâÈíÆÊ†∑Âºè */
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.5);
            border: none;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .back-button:active {
            transform: scale(0.95);
            background: rgba(0, 0, 0, 0.7);
        }

        .back-button .material-icons {
            font-size: 24px;
        }
    </style>
</head>
<body>
    <div class="loading-screen">
        <h2>Á•ûËØù‰º†ËØ¥</h2>
        <div class="loading-bar">
            <div class="loading-progress"></div>
        </div>
    </div>

    <canvas id="game-canvas"></canvas>

    <div class="ui-overlay">
        <button class="back-button" onclick="window.location.href='quwanyouxi.html'">
            <i class="material-icons">arrow_back</i>
        </button>
        <div class="status-bar">
            <div class="hp-bar">
                <div class="hp-fill" id="playerHp"></div>
            </div>
            <div class="mp-bar">
                <div class="mp-fill" id="playerMp"></div>
            </div>
        </div>

        <div class="virtual-joystick">
            <div class="joystick-handle"></div>
        </div>

        <div class="skill-bar">
            <button class="skill-btn" data-skill="1">‚öîÔ∏è</button>
            <button class="skill-btn" data-skill="2">üî•</button>
            <button class="skill-btn" data-skill="3">‚ö°</button>
            <button class="skill-btn" data-skill="4">üåÄ</button>
        </div>
    </div>

    <audio id="bgMusic" loop>
        <source src="path_to_background_music.mp3" type="audio/mpeg">
    </audio>

    <script>
        // Âú∫ÊôØÁõ∏ÂÖ≥ÂèòÈáè
        let scene, camera, renderer, controls;
        let player, boss;
        let animations = {};
        let mixer;
        let clock = new THREE.Clock();

        // Ê∏∏ÊàèÁä∂ÊÄÅ
        let gameState = {
            playerHp: 100,
            playerMp: 100,
            bossHp: 1000,
            isPlaying: false
        };

        // ÂàùÂßãÂåñÂú∫ÊôØ
        function initScene() {
            // ÂàõÂª∫Âú∫ÊôØ
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb); // Â§©Á©∫ËìùËâ≤ËÉåÊôØ

            // ÂàõÂª∫Áõ∏Êú∫
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 10);

            // ÂàõÂª∫Ê∏≤ÊüìÂô®
            renderer = new THREE.WebGLRenderer({
                canvas: document.getElementById('game-canvas'),
                antialias: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;

            // Ê∑ªÂä†ÁéØÂ¢ÉÂÖâÂíåÂπ≥Ë°åÂÖâ
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(0, 10, 10);
            directionalLight.castShadow = true;
            scene.add(directionalLight);

            // ÂàõÂª∫Âú∞Èù¢
            const groundGeometry = new THREE.PlaneGeometry(50, 50);
            const groundMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x91785b,
                roughness: 0.8,
                metalness: 0.2 
            });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);

            // Ê∑ªÂä†ËøúÊôØË£ÖÈ•∞
            addEnvironment();

            // ÂàùÂßãÂåñÊéßÂà∂Âô®
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.maxPolarAngle = Math.PI / 2;
        }

        // Âä†ËΩΩËßíËâ≤Ê®°Âûã
        async function loadCharacter() {
            const loader = new THREE.GLTFLoader();
            
            try {
                const gltf = await loader.loadAsync('path_to_character_model.glb');
                player = gltf.scene;
                player.scale.set(0.1, 0.1, 0.1);
                player.position.y = 0;
                player.castShadow = true;
                scene.add(player);

                // ËÆæÁΩÆÂä®ÁîªÊ∑∑ÂêàÂô®
                mixer = new THREE.AnimationMixer(player);
                gltf.animations.forEach(clip => {
                    animations[clip.name] = mixer.clipAction(clip);
                });

                // Êí≠ÊîæÂæÖÊú∫Âä®Áîª
                if(animations['idle']) {
                    animations['idle'].play();
                }

            } catch (error) {
                console.error('Error loading character:', error);
            }
        }

        // Âä†ËΩΩBossÊ®°Âûã
        async function loadBoss() {
            const loader = new THREE.GLTFLoader();
            
            try {
                const gltf = await loader.loadAsync('path_to_boss_model.glb');
                boss = gltf.scene;
                boss.scale.set(0.2, 0.2, 0.2);
                boss.position.set(0, 0, -10);
                boss.castShadow = true;
                scene.add(boss);

                // ËÆæÁΩÆBossÂä®Áîª
                const bossMixer = new THREE.AnimationMixer(boss);
                gltf.animations.forEach(clip => {
                    const action = bossMixer.clipAction(clip);
                    if(clip.name === 'idle') {
                        action.play();
                    }
                });

            } catch (error) {
                console.error('Error loading boss:', error);
            }
        }

        // Ê∑ªÂä†ÁéØÂ¢ÉË£ÖÈ•∞
        function addEnvironment() {
            // Ê∑ªÂä†ËøúÂ§ÑÁöÑÂ±±ËÑâ
            const mountainGeometry = new THREE.ConeGeometry(5, 10, 4);
            const mountainMaterial = new THREE.MeshStandardMaterial({ color: 0x4a5568 });
            
            for(let i = 0; i < 10; i++) {
                const mountain = new THREE.Mesh(mountainGeometry, mountainMaterial);
                mountain.position.set(
                    Math.random() * 100 - 50,
                    5,
                    Math.random() * -50 - 20
                );
                mountain.rotation.y = Math.random() * Math.PI;
                scene.add(mountain);
            }

            // Ê∑ªÂä†Ê†ëÊú®
            const treeGeometry = new THREE.CylinderGeometry(0, 1.5, 5, 8);
            const treeMaterial = new THREE.MeshStandardMaterial({ color: 0x2f855a });
            
            for(let i = 0; i < 20; i++) {
                const tree = new THREE.Mesh(treeGeometry, treeMaterial);
                tree.position.set(
                    Math.random() * 40 - 20,
                    2.5,
                    Math.random() * 40 - 20
                );
                tree.castShadow = true;
                scene.add(tree);
            }
        }

        // ËßíËâ≤ÊéßÂà∂Á≥ªÁªü
        function initControls() {
            // ËôöÊãüÊëáÊùÜÊéßÂà∂
            const joystick = document.querySelector('.virtual-joystick');
            const handle = document.querySelector('.joystick-handle');
            let isDragging = false;
            let startX, startY;

            joystick.addEventListener('touchstart', (e) => {
                isDragging = true;
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
            });

            joystick.addEventListener('touchmove', (e) => {
                if(!isDragging) return;

                const deltaX = e.touches[0].clientX - startX;
                const deltaY = e.touches[0].clientY - startY;
                const distance = Math.min(Math.sqrt(deltaX * deltaX + deltaY * deltaY), 35);
                const angle = Math.atan2(deltaY, deltaX);

                handle.style.transform = `translate(
                    ${distance * Math.cos(angle)}px,
                    ${distance * Math.sin(angle)}px
                )`;

                // ÁßªÂä®ËßíËâ≤
                if(player) {
                    const moveSpeed = 0.1;
                    player.position.x += deltaX * moveSpeed;
                    player.position.z += deltaY * moveSpeed;
                    player.rotation.y = -angle;

                    // ÂàáÊç¢Âà∞Ë∑ëÊ≠•Âä®Áîª
                    if(animations['run'] && !animations['run'].isRunning()) {
                        animations['idle'].stop();
                        animations['run'].play();
                    }
                }
            });

            joystick.addEventListener('touchend', () => {
                isDragging = false;
                handle.style.transform = 'translate(0, 0)';

                // ÂàáÊç¢ÂõûÂæÖÊú∫Âä®Áîª
                if(animations['idle'] && animations['run']) {
                    animations['run'].stop();
                    animations['idle'].play();
                }
            });
        }

        // ÊàòÊñóÁ≥ªÁªü
        function initCombat() {
            // ÊäÄËÉΩÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
            document.querySelectorAll('.skill-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const skillId = btn.dataset.skill;
                    useSkill(skillId);
                });
            });
        }

        // ‰ΩøÁî®ÊäÄËÉΩ
        function useSkill(skillId) {
            if(!gameState.isPlaying) return;

            const mpCost = {
                1: 10,  // ÊôÆÈÄöÊîªÂáª
                2: 20,  // ÁÅ´ÁêÉÊúØ
                3: 30,  // Èõ∑ÁîµÊúØ
                4: 50   // ÁªàÊûÅÊäÄËÉΩ
            };

            // Ê£ÄÊü•MPÊòØÂê¶Ë∂≥Â§ü
            if(gameState.playerMp < mpCost[skillId]) {
                showMessage("È≠îÊ≥ïÂÄº‰∏çË∂≥ÔºÅ");
                return;
            }

            // Êâ£Èô§MP
            gameState.playerMp -= mpCost[skillId];
            updateUI();

            // Êí≠ÊîæÊîªÂáªÂä®Áîª
            if(animations['attack']) {
                animations['attack'].play();
                setTimeout(() => {
                    animations['idle'].play();
                }, 1000);
            }

            // ÂàõÂª∫ÊäÄËÉΩÁâπÊïà
            createSkillEffect(skillId);

            // ÂØπBossÈÄ†Êàê‰º§ÂÆ≥
            const damage = calculateDamage(skillId);
            dealDamageToBoss(damage);
        }

        // ËÆ°ÁÆó‰º§ÂÆ≥
        function calculateDamage(skillId) {
            const baseDamage = {
                1: 50,   // ÊôÆÈÄöÊîªÂáª
                2: 100,  // ÁÅ´ÁêÉÊúØ
                3: 150,  // Èõ∑ÁîµÊúØ
                4: 300   // ÁªàÊûÅÊäÄËÉΩ
            };

            // Ê∑ªÂä†ÈöèÊú∫ÊµÆÂä®
            const variation = Math.random() * 0.2 - 0.1; // -10% Âà∞ +10%
            return Math.floor(baseDamage[skillId] * (1 + variation));
        }

        // ÂØπBossÈÄ†Êàê‰º§ÂÆ≥
        function dealDamageToBoss(damage) {
            gameState.bossHp -= damage;
            
            // ÊòæÁ§∫‰º§ÂÆ≥Êï∞Â≠ó
            showDamageNumber(damage);
            
            // Êõ¥Êñ∞BossË°ÄÊù°
            updateBossHpBar();
            
            // Ê£ÄÊü•BossÊòØÂê¶Ë¢´ÂáªË¥•
            if(gameState.bossHp <= 0) {
                gameVictory();
            }
        }

        // Âä®ÁîªÂæ™ÁéØ
        function animate() {
            requestAnimationFrame(animate);
            
            const delta = clock.getDelta();
            
            if(mixer) {
                mixer.update(delta);
            }
            
            if(controls) {
                controls.update();
            }
            
            renderer.render(scene, camera);
        }

        // ÂàùÂßãÂåñÊ∏∏Êàè
        async function initGame() {
            initScene();
            await loadCharacter();
            await loadBoss();
            initControls();
            initCombat();
            animate();
            
            // ÈöêËóèÂä†ËΩΩÂ±èÂπï
            document.querySelector('.loading-screen').style.display = 'none';
            
            // ÂºÄÂßãÊ∏∏Êàè
            gameState.isPlaying = true;
        }

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñÊ∏∏Êàè
        window.addEventListener('load', initGame);

        // Á™óÂè£Â§ßÂ∞èÊîπÂèòÊó∂Êõ¥Êñ∞Ê∏≤ÊüìÂô®ÂíåÁõ∏Êú∫
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // ËøîÂõûÊ∏∏ÊàèÂàóË°®ÂáΩÊï∞
        function returnToGameList() {
            // Ê∏ÖÁêÜÊ∏∏ÊàèËµÑÊ∫ê
            if(mixer) mixer.stopAllAction();
            if(scene) {
                scene.traverse(object => {
                    if(object.geometry) object.geometry.dispose();
                    if(object.material) {
                        if(Array.isArray(object.material)) {
                            object.material.forEach(material => material.dispose());
                        } else {
                            object.material.dispose();
                        }
                    }
                });
            }
            if(renderer) renderer.dispose();
            
            // ÂÅúÊ≠¢ËÉåÊôØÈü≥‰πê
            const bgMusic = document.getElementById('bgMusic');
            if(bgMusic) bgMusic.pause();
            
            // Áõ¥Êé•‰ΩøÁî®window.location.hrefËøõË°åË∑≥ËΩ¨
            window.location.href = 'quwanyouxi.html';
        }

        // Á°Æ‰øùËøîÂõûÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨Âô®Ê≠£Á°ÆÁªëÂÆö
        document.addEventListener('DOMContentLoaded', function() {
            const backButton = document.querySelector('.back-button');
            if(backButton) {
                backButton.addEventListener('click', returnToGameList);
            }
        });
    </script>
</body>
</html> 